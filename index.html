<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificador de Obras EDP â€“ Atuamax</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #1a1a1a;
      --card: #222222;
      --text: #f0f0f0;
      --sub: #a0a0a0;
      --accent: #ff6600;
      --border: #444444;
      --success: #4ade80;
      --error: #f87171;
    }

    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 0;
    }

    .wrap {
      width: 100%;
      max-width: 1200px;
      height: 100vh;
      background: var(--card);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .5);
    }

    header {
      padding: 1rem 1.25rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      color: var(--accent);
      flex-shrink: 0;
      font-size: 1.1rem;
    }

    main {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) #2a2a2a;
    }

    main::-webkit-scrollbar {
      width: 8px;
    }

    main::-webkit-scrollbar-thumb {
      background-color: var(--accent);
      border-radius: 4px;
    }

    main::-webkit-scrollbar-track {
      background: #2a2a2a;
    }

    .msg {
      max-width: 95%;
      padding: .75rem 1rem;
      border-radius: 18px;
      font-size: .95rem;
      line-height: 1.5;
    }

    .user {
      background: var(--accent);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
    }

    .bot {
      background: #333333;
      align-self: flex-start;
      border-bottom-left-radius: 6px;
    }

    .time {
      font-size: .7rem;
      opacity: .7;
      display: block;
      margin-top: .5rem;
      text-align: right;
    }

    .input-box {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .75rem 1rem;
      border-top: 1px solid var(--border);
      background: #2a2a2a;
      flex-shrink: 0;
    }

    input[type="text"] {
      flex: 1;
      padding: .7rem 1rem;
      border: 1px solid var(--border);
      border-radius: 24px;
      outline: none;
      font-size: .95rem;
      background: #1a1a1a;
      color: var(--text);
    }

    input[type="file"] {
      display: none;
    }

    button {
      width: 42px;
      height: 42px;
      border: none;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all .2s;
    }

    button:hover:not(:disabled) {
      background: #e55a00;
      transform: scale(1.05);
    }

    button:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none;
    }

    .stats {
      background: #2a2a2a;
      padding: .75rem 1rem;
      border-radius: 8px;
      margin: .5rem 0;
      font-size: .9rem;
      border-left: 4px solid var(--accent);
    }

    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin: .5rem 0;
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .8rem;
      min-width: 1000px;
    }

    th, td {
      padding: .5rem;
      border: 1px solid var(--border);
      text-align: left;
      word-wrap: break-word;
      max-width: 150px;
    }

    th {
      background: #333333;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }

    tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    .cep-valid {
      color: var(--success);
      font-weight: 600;
    }

    .download {
      margin-top: .75rem;
      font-size: .85rem;
      padding: .6rem 1.2rem;
      border-radius: 24px;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 500;
      width: auto;
      height: auto;
    }

    .download:hover {
      background: #e55a00;
    }

    .prefixos-info {
      font-size: .85rem;
      color: var(--sub);
      margin-top: .5rem;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: all .2s;
    }

    .file-input-wrapper:hover {
      background: #e55a00;
      transform: scale(1.05);
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }

    .file-input-wrapper .file-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      color: #fff;
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      .wrap {
        max-width: 100%;
      }

      header {
        font-size: .95rem;
        padding: .75rem 1rem;
      }

      table {
        font-size: .75rem;
        min-width: 800px;
      }

      th, td {
        padding: .4rem;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>Verificador EDP - Atuamax</header>

    <main id="chat">
      <div class="msg bot">
        ðŸ“‚ <strong>Envie um arquivo .xlsx com obras</strong><br>
        <div class="prefixos-info">
          <strong>Prefixos CEP vÃ¡lidos:</strong><br>
          07124, 07130, 07131, 07132, 07134, 07135, 07087, 07072, 07073, 07074, 07075, 07076, 07077, 07080, 07081, 07082, 07083, 07084, 07085
        </div>
      </div>
    </main>

    <div class="input-box" id="dropZone">
      <input id="userInput" type="text" placeholder="Cole os dados aqui ou use o botÃ£o para carregar arquivo..." />
      <div class="file-input-wrapper">
        <input id="fileInput" type="file" accept=".xlsx,.xls">
        <label for="fileInput" class="file-label">ðŸ“Ž</label>
      </div>
      <button id="sendBtn" title="Processar">âž¤</button>
    </div>
  </div>

  <script>
    const prefixos = [
      '07124','07130','07131','07132','07134','07135','07087',
      '07072','07073','07074','07075','07076','07077','07080',
      '07081','07082','07083','07084','07085'
    ];
    let currentData = [];
    let filteredData = [];

    const fileInput = document.getElementById('fileInput');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const chat = document.getElementById('chat');
    const dropZone = document.getElementById('dropZone');

    function getTime() {
      return new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    function addMessage(text, sender = 'bot') {
      const div = document.createElement('div');
      div.className = 'msg ' + sender;
      div.innerHTML = text + '<span class="time">' + getTime() + '</span>';
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.style.border = '2px dashed var(--accent)';
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.style.border = 'none';
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.style.border = 'none';
      const file = e.dataTransfer.files[0];
      if (file) processFile(file);
    });

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) processFile(file);
    });

    function processFile(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          if (!jsonData.length) throw new Error("Arquivo vazio ou ilegÃ­vel.");
          currentData = jsonData;
          filterData();
        } catch (err) {
          addMessage("Erro: " + err.message, 'bot');
        }
      };
      reader.readAsArrayBuffer(file);
      addMessage("ðŸ“„ Arquivo recebido: <strong>" + file.name + "</strong>", 'user');
    }

    function filterData() {
      const headers = currentData[0];
      const rows = currentData.slice(1);

      const cepCols = [];
      headers.forEach((h, i) => {
        if (typeof h === 'string' && /cep|endereÃ§o|address/i.test(h)) cepCols.push(i);
      });
      if (!cepCols.length) cepCols.push(...headers.keys());

      filteredData = rows.filter(row => {
        return cepCols.some(i => {
          const val = String(row[i] || '').replace(/\D/g, '');
          return prefixos.some(p => val.startsWith(p));
        });
      });

      displayResults(headers, filteredData);
    }

    function processExcelCell(cell, header) {
      if (typeof header === 'string') {
        const h = header.toLowerCase();
        if ((h.includes('inÃ­cio') || h.includes('inicio') || h.includes('final') || h.includes('hora')) &&
          typeof cell === 'number' && cell >= 0 && cell < 1) {
          const totalMinutes = Math.round(cell * 24 * 60);
          const hh = String(Math.floor(totalMinutes / 60)).padStart(2, '0');
          const mm = String(totalMinutes % 60).padStart(2, '0');
          return `${hh}:${mm}`;
        }
      }
      return cell;
    }

    function displayResults(headers, data) {
      const stats = document.createElement('div');
      stats.className = 'stats';
      stats.style.display = 'block';
      stats.innerHTML = `âœ… <strong>Filtragem concluÃ­da!</strong><br>ðŸ“Š Total de obras vÃ¡lidas: <strong>${data.length}</strong>`;
      addMessage(stats.outerHTML, 'bot');

      if (data.length === 0) {
        addMessage("Nenhuma obra encontrada nos CEPs da regiÃ£o.", 'bot');
        return;
      }

      // Montar tabela
      let tabelaHtml = `
        <div class="table-container">
          <table>
            <thead>
              <tr>${headers.map(h => `<th>${h || 'Coluna'}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${data.map(row => `
                <tr>
                  ${headers.map((h, i) => {
                    let val = processExcelCell(row[i] || '', h);
                    if (/cep/i.test(h)) val = `<span class="cep-valid">${val}</span>`;
                    return `<td>${val}</td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
          <button class="download" onclick="exportResults()">ðŸ“¥ Exportar Resultados</button>
        </div>
      `;

      addMessage(tabelaHtml, 'bot');
    }

    function exportResults() {
      if (!filteredData.length) return;
      const headers = currentData[0];
      const processed = filteredData.map(row =>
        row.map((cell, i) => processExcelCell(cell, headers[i]))
      );
      const exportArray = [headers, ...processed];
      const ws = XLSX.utils.aoa_to_sheet(exportArray);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Obras Regiao');
      XLSX.writeFile(wb, `obras_edp_regiao_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`);
    }

    // Enter para processar
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        if (!userInput.value.trim()) return;
        addMessage(userInput.value, 'user');
        // Simular processamento de texto colado como CSV/TXT
        currentData = [userInput.value.split('\t')]; // simulaÃ§Ã£o simples
        filteredData = [userInput.value.split('\t')]; // simulaÃ§Ã£o simples
        displayResults(['Dados colados'], filteredData);
        userInput.value = '';
      }
    });

    sendBtn.addEventListener('click', () => {
      if (!userInput.value.trim()) return;
      addMessage(userInput.value, 'user');
      currentData = [userInput.value.split('\t')];
      filteredData = [userInput.value.split('\t')];
      displayResults(['Dados colados'], filteredData);
      userInput.value = '';
    });
  </script>
</body>
</html>
